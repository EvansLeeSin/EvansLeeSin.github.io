---
title: JavaSPI机制
date: 2024-07-29 15:23:31
tags: Java
---

![API&SPI](https://oss.javaguide.cn/github/javaguide/java/basis/spi-vs-api.png)

SPI 即 Service Provider Interface，字面意思是服务提供者的接口；它和API(**Application Programming Interface**)有些类似，但要注意其中的不同：

- **定义方式不同：**API是开发者主动编写的接口并将其实现，供其他人使用；而SPI是由框架(如Spring)或者是库的提供方去**定义接口**，而实现是第三方开发者实现。
- **调用方式不同：**API一般都是直接调用接口的方法就可以使用；而SPI是通过配置文件来指定具体要实现的类，然后由框架读取并加载使用。
- **灵活性不同：**API的实现在编译的时候就被确定了，无法动态替换；而SPI可以通过改变配置文件来实现动态的加载和替换。
- **依赖关系不同：**API需要调用方添加依赖，即需要引入API所在的库才能使用其功能；而SPI是调用方依赖，即框架或库需要引入第三方的依赖才能加载和调用。

### 实现原理

1. 定义接口：需要框架或者库提供方主动的去定义一个接口作为扩展点。
2. 编写实现类：第三方开发者根据约定给定的接口，来进行具体的实现，并打包成jar文件。
3. 创建配置文件：在约定的配置文件目录(META-INF/services)创建一个以**接口全限定命名**的文本文件，内容是**实现类的全限定名**，每行一个。
4. 加载实现类：框架或库通过类加载器读取配置文件中的实现类的信息(实现类的全类名)，读到后判断是否与SPI接口为相同的类型，是的话就利用**反射**构造其对应的实例对象。
5. 调用方法：构造出来的实例对象会放在Providers的列表(List)中,框架或者库根据需要来调用实现类。

### 缺点

- 因为是允许第三方实现的接口，那么就无法保证其质量，可能会导致第三方代码导致的bug产生。
- 配置文件中的内容其实就是纯文本的接口，以供类加载器读取类名加载，但这仅通过换行来维护接口列表，容易会变得复杂易出错。
- 接上条的说法，框架加载时是通过逐条遍历来实现的，这样的效率会相对比较低。
- 我们在调用SPI时一般会通过`load`方法进行，但当有多个`ServerLoader`同时进行`load`时，会产生并发问题。
